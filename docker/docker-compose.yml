services:
  # MySQL - 대화 기록, 사용자 정보 저장
  mysql:
    image: mysql:8.0
    container_name: infra-ai-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-infra_ai_agent}
      MYSQL_USER: ${MYSQL_USER:-infra_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-infra_password}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ../scripts/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL - 센서 데이터 저장
  postgres:
    image: postgres:15
    container_name: infra-ai-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DATABASE:-sensor_data}
      POSTGRES_USER: ${POSTGRES_USER:-sensor_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-sensor_password}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../scripts/init_sensor_db.sql:/docker-entrypoint-initdb.d/init_sensor_db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sensor_user} -d ${POSTGRES_DATABASE:-sensor_data}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend - FastAPI
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: infra-ai-backend
    restart: unless-stopped
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=${MYSQL_USER:-infra_user}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-infra_password}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-infra_ai_agent}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-sensor_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sensor_password}
      - POSTGRES_DATABASE=${POSTGRES_DATABASE:-sensor_data}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-super-secret-key-change-in-production}
      - LLM_API_BASE_URL=${LLM_API_BASE_URL:-https://api.openai.com/v1}
      - LLM_API_KEY=${LLM_API_KEY}
      - LLM_MODEL=${LLM_MODEL:-gpt-4o}
      - MCP_SERVER_URL=http://mcp-server:8001
    ports:
      - "8000:8000"
    depends_on:
      mysql:
        condition: service_healthy
      postgres:
        condition: service_healthy
    volumes:
      - ../backend:/app

  # MCP Server - FastMCP
  mcp-server:
    build:
      context: ../mcp-server
      dockerfile: Dockerfile
    container_name: infra-ai-mcp
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-sensor_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sensor_password}
      - POSTGRES_DATABASE=${POSTGRES_DATABASE:-sensor_data}
    ports:
      - "8001:8001"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ../mcp-server:/app

  # Frontend - React (개발 서버)
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: infra-ai-frontend
    restart: unless-stopped
    environment:
      - VITE_PROXY_TARGET=http://backend:8000
    ports:
      - "5173:5173"
    depends_on:
      - backend
    volumes:
      - ../frontend:/app
      - /app/node_modules

  # Nginx - 리버스 프록시 (프로덕션용)
  nginx:
    image: nginx:alpine
    container_name: infra-ai-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
      - frontend
    profiles:
      - production

volumes:
  mysql_data:
  postgres_data:
